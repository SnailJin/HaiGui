<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./static/css/bootstrap.min.css">
    <link rel="stylesheet" href="./static/css/base.css">
    <link rel="stylesheet" href="./static/css/jquery.datetimepicker.css">
    <script style="text/javascript"  src="./static/js/jquery.min.js"></script>
    <script src="./static/js/bootstrap.min.js"></script>
    <script style="text/javascript"  src="./static/js/base.js"></script>
    <script style="text/javascript"  src="./static/js/common.js"></script>
    <script style="text/javascript"  src="./static/js/jquery.datetimepicker.full.min.js"></script>
    <script style="text/javascript"  src="./static/js/jquery.poplayer.js"></script>
    <script style="text/javascript"  src="./static/js/jquery.loading.js"></script>
    <script style="text/javascript"  src="./static/js/jquery.scroll.js"></script>
    <style>

    </style>
    <script>
        var orderType ="start_time";
        var cityFilter=null;
        var minimusSalaryFilter =null;
        var maximusSalaryFilter =null;
        var title =null;
        //分页处理
        loading=function(flag){
            if(flag){
                $('#list').popLoading();
            }else{
                $('#list').removeLoading();
            }
        };
        success=function(data){
            data = JSON.parse(data);
            if(data.code == 0){
                if(nextPage == 1){
                    $('#list').children().remove();
                }
                loadOccupationListToHtml(data.body.list)
                if(data.body.list.length < pageSize){
                    nextPage = -1;
                    $('#list').append('<div style="text-align: center;"><div style="display: inline-block; line-height: 16px; padding-left: 20px;"><medium> ( ⊙ o ⊙ ) 没有更多了</medium></div></div>');
                }else{
                    nextPage=nextPage+1;
                }
            }else{
                return_error(data);
            }
        };
       $(function(){
           set_user_info_html();
           loadOccupationList("start_time");
           $("#start_time").addClass("selected");
           //筛选
           $('.sort a').click(function(){
               $('.sort a').removeClass("selected");
               $(this).addClass("selected");
               orderType=this.id;
               nextPage =1;
               loadOccupationList(true);
           })
           $('.area a,.income a').click(function(){
               var filterType = $(this).closest("li");
               var type= filterType.attr("type")
               var flag =$(this).hasClass("selected");
               filterType.find("a").removeClass("selected");
               if(!flag){
                   $(this).addClass("selected");
                   if(type == 'income'){
                       incomeList = $(this).attr("value").split("-");
                       minimusSalaryFilter=incomeList[0];
                       maximusSalaryFilter=incomeList[1];
                   }else if(type == 'area'){
                       cityFilter = $(this).attr("value");
                   }else{
                       return false;
                   }
               }else{
                   if(type == 'income'){
                       incomeList = this.value.split("-");
                       minimusSalaryFilter=null;
                       maximusSalaryFilter=null;
                   }else if(type == 'area'){
                       cityFilter = null;
                   }else{
                       return false;
                   }
               }
               nextPage =1;
               loadOccupationList(true);
           })
            //搜索
            $('.search-button').click(search);
           $('.search-input').keypress(function(e){
               if(event.keyCode == "13")
               {
                   search();
               }
           });
       });
        //滑动加载
        $(window).scroll( function() {
            if(get_load_next_page()){
                /* 	console.log("滚动条到顶部的垂直高度: "+$(document).scrollTop());
                 console.log("页面的文档高度 ："+$(document).height());
                 console.log('浏览器的高度：'+$(window).height()); */
                loadOccupationList(false);
            }
        });
        //搜索
        function search(){
            var search = $('.search-input').val().trim();
            if(search == ""){
                title=null;
            }else{
                title=search;
            }
            nextPage =1;
            loadOccupationList(true);
        }
        /**
         * 加载岗位列表
         * @param flag
         */
       function loadOccupationList(flag){
           formData.key="LoadOccupationList"
           formData.body={title:null,category:null,salary:null,city:cityFilter,minimusSalary:maximusSalaryFilter,maximusSalary:maximusSalaryFilter,enterpriseName:null,city:null,city:null,order:"start_time",pageNo:nextPage,pageSize:pageSize};
           formData.body.order=orderType;
           formData.body.city=cityFilter;
           formData.body.minimusSalary=minimusSalaryFilter;
           formData.body.maximusSalary=maximusSalaryFilter;
           loadData(success,loading,JSON.stringify(formData),flag);
       }
       //加载列表到html
       function loadOccupationListToHtml(occupationList){
           for(var i in occupationList){
               var job =$("#job_clone").clone();
               var occupation = occupationList[i];
               job.find(".title").text(occupation.title);
               job.find(".title").click(function(){
                   var id = $(this).closest(".job").find("[name='occupationId']").val();
                   window.location="job_detail.html?id="+id;
               })
               job.find(".salary").text(occupation.minimusSalary+"万-"+occupation.maximusSalary+"万");
               //job.find(".city").text(occupation.minimusSalary+"万-"+occupation.maximusSalary+"万");
               job.find(".minimusAge").text(occupation.workingAge+"以上工作经验");
               job.find(".time-info").text(occupation.startTime);
               job.find(".category").text(occupation.category);
               job.find(".enterpriseName").text(occupation.enterpriseName);
               job.find("[name='occupationId']").val(occupation.occupationId);
               if(occupation.isFavouriteOccupation){
                   job.find(".collect").text("取消收藏").click(function(e){
                       delCollect(this)
                   });
               }else{
                   job.find(".collect").text("收藏").click(function(e){
                       addCollect(this)
                   })
               }
               $("#list").append(job.children());
           }
       }
        function addCollect(context){
            createCollect(0,context);
        }
        function delCollect(context){
            createCollect(1,context);
        }

        //添加删除收藏  0添加，1删除
        function createCollect(collectStatus,context){
            current=context;
            if(collectStatus == 1){
                formData.key="RemoveFavouriteOccupation";
            }else{
                formData.key="AddFavouriteOccupation";
            }

            var occupationId = $(context).closest('.job').find('[name="occupationId"]').val().trim();
            formData.body={};
            formData.body.occupationId=parseInt(occupationId);
            $.ajax({
                type: 'post',
                url:url,
                data:JSON.stringify(formData),
                beforeSend: function(XMLHttpRequest){
                },
                success: function(data, textStatus){
                    data = JSON.parse(data);
                    if(data.code == 0){
                        if(data.key == "AddFavouriteOccupation" ){
                            $(current).text("取消收藏");
                            $(current).unbind().bind("click",function(e){
                                delCollect(this)
                            });
                        }else{
                            $(current).text("收藏");
                            $(current).unbind().bind("click",function(e){
                                addCollect(this)
                            })
                        }
                    }else{
                        return_error(data);
                    }
                },
                complete: function(XMLHttpRequest, textStatus){
                },
                error: function(response){
                    alert('网络异常!')
                }
            });
        }

    </script>
    <title>主页</title>
</head>
<body>
<div id="header"></div>
<div class="wap">
    <div class="container">
        <div class="row">
            <div class="col-xs-3">
                <div class="user_info">
                    <div class="row">
                        <div class="col-xs-6">
                            <img class="avatar-self" src="./static/images/avatar.gif">
                        </div>
                        <div class="col-xs-6 link">
                            <div>
                                <a href="acoount.html"><i class="glyphicon glyphicon-edit">个人信息</i></a>
                            </div>
                            <div style="border: 0px">
                                <a href="change_password.html"><i class="glyphicon glyphicon-star">修改密码</i></a>
                            </div>
                        </div>
                    </div>
                    <div class="row user-content">
                        <p class="username-self"><h4 id="username">金李广</h4></p>
                        <p id="email">jin521436@163.com</p>
                    </div>
                </div>
            </div>
            <div class="col-xs-9 ">
                <div class="row search">
                    <div class="row">
                        <div class="col-xs-12" style="padding-right: 10px">
                            <input class="search-input" placeholder="&nbsp;请输入职位名称">
                            <input class="search-button" type="submit" value="搜索  ">
                        </div>
                    </div>
                    <ul class="filter-condition">
                        <li class="area"  type="area">
                            <span class="title">工作地点:</span>
                            <a value="北京">北京</a>
                            <a value="上海">上海</a>
                            <a value="杭州">杭州</a>
                            <a value="广州">广州</a>
                            <a class="btn-more" href="javascript:;">
                                更多 
                            </a>
                        </li>
                        <li class="income" type="income">
                            <span class="title">年&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;薪:</span>
                            <a value="10-15">10-15万</a>
                            <a  value="15-20">15-20万</a>

                            <a class="btn-more" href="javascript:;">
                                更多 
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- 排序 -->

                <ul class="sort">
                    <li>
                        <span class="title">排序方式:</span>
                        <a id="maximus_salary">薪水</a>
                        <a id="start_time">默认</a>
                    </li>
                </ul>

                <!--职位 -->
                <div id="list"></div>
            </div>
        </div>
    </div>
    <div style="height: 60px"></div>
</div>
<!-- 登录
<div class="login-capacity">

</div>
 -->
<div id="footer"></div>
<!-- clone -->
<div id="job_clone" style="display: none">
    <div class="row job">
        <input type="hidden" name="occupationId">
        <div class="col-xs-6 job-info">
            <div class="row">
                <h4 class="title"></h4>
            </div>
            <div class="row">
                <p class="job-desc">
                    <span class="salary" style="border: 0px;padding-left: 0px;color: red;">15-20万</span>
                    <span class="city">杭州</span>
                    <span class="workingAge">1年以上工作经验</span>
                </p>
            </div>
            <div class="row">
                <p class="time-info">发布于1小时前</p>
            </div>
        </div>
        <div class="col-xs-6 company">
            <div class="row">
                <h5 class="enterpriseName"></h5>
            </div>
            <div class="row">
                <p class="category"> 移动互联网 · 企业服务 / 上市公司</p>
            </div>
            <div class="row">
                <p class="job-desc">
                    <a class="collect" href="javascript:void"><span style="border: 0px;padding-left: 0px;color: #019875;">收藏</span></a>
                </p>
            </div>
        </div>
    </div>
</div>
</body>
</html>